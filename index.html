<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recmaths Voting Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .rank-item { transition: all 0.2s; }
        .rank-item:active { transform: scale(0.98); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 font-sans">

    <!-- LANDING SCREEN -->
    <div id="landing-screen" class="container mx-auto p-6 max-w-md mt-10">
        <div class="bg-white p-8 rounded-xl shadow-xl text-center">
            <h1 class="text-3xl font-bold mb-2 text-indigo-700">üó≥Ô∏è Recmaths Voting</h1>
            <p class="text-slate-500 mb-8">Weighted Kemeny-Young System</p>

            <div class="space-y-4">
                <button onclick="showCreateScreen()" class="w-full bg-indigo-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-indigo-700 shadow-md transition transform hover:-translate-y-1">
                    Create New Session
                </button>
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-sm">OR JOIN EXISTING</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                <div>
                    <input id="join-code-input" type="text" placeholder="Enter 4-Digit Room Code" class="w-full p-3 border-2 border-gray-200 rounded-lg text-center text-xl tracking-widest font-mono focus:border-indigo-500 focus:outline-none mb-3 uppercase">
                    <button onclick="joinSession()" class="w-full bg-white border-2 border-indigo-100 text-indigo-600 py-3 rounded-lg font-bold hover:bg-indigo-50 transition">
                        Join Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CREATE SCREEN -->
    <div id="create-screen" class="hidden container mx-auto p-6 max-w-md mt-10">
        <div class="bg-white p-6 rounded-xl shadow-xl">
            <h2 class="text-xl font-bold mb-4 text-slate-700">Setup Competition</h2>
            <p class="mb-2 text-sm text-slate-500">Participant Names (comma separated):</p>
            <textarea id="participants-input" class="w-full p-3 border rounded-lg mb-4 h-32 focus:ring-2 ring-indigo-500 bg-slate-50" placeholder="Alicia, Ginny, Robin, Debbie, Gwendolyn"></textarea>
            <div class="flex gap-3">
                <button onclick="location.reload()" class="flex-1 bg-gray-200 text-gray-600 py-3 rounded-lg font-bold">Back</button>
                <button onclick="createSession()" class="flex-[2] bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-md">
                    Launch Room üöÄ
                </button>
            </div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD (Live Results) -->
    <div id="admin-screen" class="hidden container mx-auto p-6 max-w-2xl mt-6">
        <div class="bg-white p-6 rounded-xl shadow-xl border-t-4 border-indigo-500">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wide">Room Code</h2>
                    <div id="admin-room-code" class="text-5xl font-mono font-black text-indigo-600 tracking-wider"></div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-bold text-gray-400 uppercase">Votes Cast</div>
                    <div id="vote-count" class="text-3xl font-bold text-gray-800">0 / 0</div>
                </div>
            </div>

            <div class="bg-slate-50 p-4 rounded-lg mb-6 border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-3">Live Status:</h3>
                <div id="admin-voter-list" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                    <!-- Voter badges injected here -->
                </div>
            </div>

            <button onclick="generateCppCode()" class="w-full bg-slate-800 text-green-400 py-4 rounded-lg font-mono font-bold text-lg hover:bg-slate-900 shadow-lg flex justify-center items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Generate C++ Data
            </button>
            
            <div id="cpp-export-area" class="hidden mt-4">
                <textarea id="cpp-output" class="w-full bg-slate-900 text-green-400 font-mono text-xs p-4 rounded h-64 mb-2" readonly></textarea>
                <button onclick="copyToClipboard()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded text-sm font-bold hover:bg-gray-300 w-full">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- VOTER IDENTITY SCREEN -->
    <div id="identity-screen" class="hidden container mx-auto p-6 max-w-md mt-10">
        <div class="bg-white p-6 rounded-xl shadow-xl">
            <h2 class="text-xl font-bold mb-2">Who are you?</h2>
            <p class="text-slate-500 text-sm mb-4">Select your name to begin voting.</p>
            <div id="voter-buttons" class="grid grid-cols-1 gap-2 max-h-96 overflow-y-auto">
                <!-- Names injected here -->
            </div>
        </div>
    </div>

    <!-- VOTING BOOTH SCREEN -->
    <div id="voting-screen" class="hidden container mx-auto p-4 max-w-lg mt-4">
        <div class="bg-white p-4 rounded-xl shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-xs font-bold text-gray-400 uppercase">Voting As</h2>
                    <div id="current-voter-display" class="text-xl font-bold text-indigo-700"></div>
                </div>
                <div class="text-right">
                    <h2 class="text-xs font-bold text-gray-400 uppercase">Room</h2>
                    <div id="voter-room-code" class="text-xl font-mono font-bold text-gray-600"></div>
                </div>
            </div>

            <!-- TABS -->
            <div class="flex mb-4 bg-gray-100 p-1 rounded-lg">
                <button id="tab-primary" onclick="switchTab('primary')" class="flex-1 py-2 rounded-md text-sm font-bold shadow-sm bg-white text-indigo-600 transition-all">Primary (80%)</button>
                <button id="tab-secondary" onclick="switchTab('secondary')" class="flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-gray-700 transition-all">Secondary (20%)</button>
            </div>

            <!-- SORTING VIEW -->
            <div id="sort-container" class="min-h-[400px]">
                <div class="flex gap-3 h-full">
                    <!-- POOL -->
                    <div class="w-1/2 flex flex-col">
                        <h3 class="font-bold text-xs uppercase text-gray-400 mb-2 text-center">Tap to Add</h3>
                        <div id="pool-list" class="space-y-2 flex-grow overflow-y-auto p-1"></div>
                    </div>
                    
                    <!-- RANKED -->
                    <div class="w-1/2 flex flex-col">
                        <h3 class="font-bold text-xs uppercase text-indigo-400 mb-2 text-center">Your Ranking</h3>
                        <div id="ranked-list" class="space-y-2 flex-grow bg-indigo-50 rounded-lg p-2 border-2 border-dashed border-indigo-200 overflow-y-auto relative">
                            <div id="empty-state" class="absolute inset-0 flex items-center justify-center text-center p-4 text-indigo-200 text-sm font-bold pointer-events-none">
                                Tap names on left to rank them here
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <button onclick="submitVote()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-700 shadow-lg transition transform active:scale-95">
                    Submit Ballot üó≥Ô∏è
                </button>
            </div>
        </div>
    </div>

    <!-- SUCCESS SCREEN -->
    <div id="success-screen" class="hidden container mx-auto p-6 max-w-md mt-20 text-center">
        <div class="bg-white p-8 rounded-full shadow-2xl inline-block mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
        </div>
        <h2 class="text-3xl font-bold text-slate-800 mb-2">Vote Recorded!</h2>
        <p class="text-slate-500">You can close this tab now.</p>
    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let currentRoom = null;
        let participantNames = [];
        let myIdentity = null;
        let tempVotes = { primary: [], secondary: [] };
        let activeTab = 'primary';
        let unsubscribeRoom = null;
        let db = null;
        let auth = null;
        let appId = 'default';

        // --- EXPORT FUNCTIONS FOR HTML ---
        window.switchScreen = (id) => {
            ['landing-screen', 'create-screen', 'admin-screen', 'identity-screen', 'voting-screen', 'success-screen'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        };

        window.showCreateScreen = () => window.switchScreen('create-screen');

        window.switchTab = (tab) => {
            activeTab = tab;
            const pBtn = document.getElementById('tab-primary');
            const sBtn = document.getElementById('tab-secondary');
            
            if(tab === 'primary') {
                pBtn.className = "flex-1 py-2 rounded-md text-sm font-bold shadow-sm bg-white text-indigo-600 transition-all";
                sBtn.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-gray-700 transition-all";
            } else {
                sBtn.className = "flex-1 py-2 rounded-md text-sm font-bold shadow-sm bg-white text-indigo-600 transition-all";
                pBtn.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-gray-700 transition-all";
            }
            renderBooth();
        };

        window.toggleRank = (name) => {
            const list = tempVotes[activeTab];
            const idx = list.indexOf(name);
            if (idx === -1) list.push(name);
            else list.splice(idx, 1);
            renderBooth();
        };

        window.copyToClipboard = () => {
            const el = document.getElementById('cpp-output');
            el.select();
            document.execCommand('copy');
            alert("Copied!");
        };

        // --- FIREBASE INIT ---
        async function initFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyBlhwixxs7z1p9AMqrAv5cXkCne1SnRFlw",
                  authDomain: "kekswettbewerb25.firebaseapp.com",
                  projectId: "kekswettbewerb25",
                  storageBucket: "kekswettbewerb25.firebasestorage.app",
                  messagingSenderId: "361476401776",
                  appId: "1:361476401776:web:902ef14f83d990b63ae2b5",
                  measurementId: "G-JQ6K8G0Q49"
                };
                const manualConfig = {
                    apiKey: "AIzaSyBlhwixxs7z1p9AMqrAv5cXkCne1SnRFlw",
                    authDomain: "recmaths.firebaseapp.com",
                    projectId: "recmaths",
                    storageBucket: "recmaths.firebasestorage.app",
                    messagingSenderId: "361476401776",
                    appId: "1:361476401776:web:902ef14f83d990b63ae2b5",
                    measurementId: "G-JQ6K8G0Q49"
                };

                let config;
                
                // If running in the AI preview environment, use auto-config.
                if (typeof __firebase_config !== 'undefined') {
                    config = JSON.parse(__firebase_config);
                    if (typeof __app_id !== 'undefined') appId = __app_id;
                } else {
                    // If running on GitHub/Localhost, use manualConfig
                    config = manualConfig;
                }

                if (!config.apiKey || config.apiKey.includes("REPLACE_ME")) {
                    console.error("Firebase Config Missing!");
                    // We don't alert here to allow the UI to load, but actions will fail.
                    return;
                }

                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                
                await signInAnonymously(auth);
                console.log("Connected to Database");

            } catch (e) {
                console.error("Firebase Init Error:", e);
                alert("Database connection failed. Did you paste the config correctly?");
            }
        }

        initFirebase();

        // --- CORE LOGIC ---

        window.createSession = async () => {
            if (!db) return alert("Database not connected! Edit the HTML file and paste your Firebase Config.");
            
            const raw = document.getElementById('participants-input').value;
            const names = raw.split(',').map(s => s.trim()).filter(s => s.length > 0);
            
            if (names.length < 2) return alert("Need at least 2 participants");

            const roomCode = Math.floor(1000 + Math.random() * 9000).toString();
            const roomId = `room_${roomCode}`;

            const configRef = doc(db, 'artifacts', appId, 'public', 'data', roomId, 'config');
            
            await setDoc(configRef, {
                participants: names,
                createdAt: new Date().toISOString(),
                adminId: auth.currentUser?.uid || 'anon'
            });

            enterAdminMode(roomCode, names);
        };

        window.joinSession = async () => {
            if (!db) return alert("Database not connected! Edit the HTML file and paste your Firebase Config.");

            const code = document.getElementById('join-code-input').value.trim();
            if (code.length !== 4) return alert("Invalid code format");
            
            const roomId = `room_${code}`;
            const configRef = doc(db, 'artifacts', appId, 'public', 'data', roomId, 'config');
            
            try {
                const snap = await getDoc(configRef);
                if (!snap.exists()) return alert("Room not found!");

                currentRoom = roomId;
                participantNames = snap.data().participants;
                
                renderIdentityPicker(code);
                window.switchScreen('identity-screen');
            } catch (e) {
                console.error(e);
                alert("Connection failed. Check console.");
            }
        };

        window.pickIdentity = async (name) => {
            const voteRef = doc(db, 'artifacts', appId, 'public', 'data', currentRoom, `vote_${name}`);
            const snap = await getDoc(voteRef);
            
            if (snap.exists()) {
                if(!confirm(`${name} has already voted! Continue anyway (edit vote)?`)) return;
            }

            myIdentity = name;
            tempVotes.primary = [];
            tempVotes.secondary = [];
            
            document.getElementById('current-voter-display').innerText = name;
            document.getElementById('voter-room-code').innerText = currentRoom.split('_')[1];
            renderBooth();
            window.switchScreen('voting-screen');
        };

        window.submitVote = async () => {
            if (tempVotes.primary.length < participantNames.length - 1 || 
                tempVotes.secondary.length < participantNames.length - 1) {
                if(!confirm("You haven't ranked everyone. Submit partially?")) return;
            }

            const voteRef = doc(db, 'artifacts', appId, 'public', 'data', currentRoom, `vote_${myIdentity}`);
            await setDoc(voteRef, {
                primary: tempVotes.primary,
                secondary: tempVotes.secondary,
                voter: myIdentity
            });

            window.switchScreen('success-screen');
        };

        window.generateCppCode = async () => {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', currentRoom);
            const snaps = await getDocs(colRef);
            
            let pVotes = {};
            let sVotes = {};

            snaps.forEach(doc => {
                if (doc.id === 'config') return;
                const data = doc.data();
                pVotes[data.voter] = data.primary;
                sVotes[data.voter] = data.secondary;
            });

            let cpp = `    // Data from Room ${currentRoom.split('_')[1]}\n`;
            cpp += `    std::vector<std::string> participants = { ${participantNames.map(p => `"${p}"`).join(", ")} };\n\n`;
            
            cpp += `    votings primary = {\n`;
            participantNames.forEach(name => {
                if (pVotes[name]) {
                    cpp += `        { "${pVotes[name].join('", "')}" }, // ${name}\n`;
                }
            });
            cpp += `    };\n\n`;

            cpp += `    votings secondary = {\n`;
            participantNames.forEach(name => {
                if (sVotes[name]) {
                    cpp += `        { "${sVotes[name].join('", "')}" }, // ${name}\n`;
                }
            });
            cpp += `    };\n`;

            const area = document.getElementById('cpp-export-area');
            area.classList.remove('hidden');
            document.getElementById('cpp-output').value = cpp;
        };

        // --- RENDER HELPERS ---

        function enterAdminMode(roomCode, names) {
            currentRoom = `room_${roomCode}`;
            participantNames = names;
            
            document.getElementById('admin-room-code').innerText = roomCode;
            window.switchScreen('admin-screen');

            const colRef = collection(db, 'artifacts', appId, 'public', 'data', currentRoom);
            unsubscribeRoom = onSnapshot(colRef, (snapshot) => {
                let votesCount = 0;
                const votedNames = [];
                snapshot.forEach(doc => {
                    if (doc.id !== 'config') {
                        votesCount++;
                        votedNames.push(doc.data().voter);
                    }
                });
                document.getElementById('vote-count').innerText = `${votesCount} / ${names.length}`;
                
                const container = document.getElementById('admin-voter-list');
                container.innerHTML = names.map(n => {
                    const hasVoted = votedNames.includes(n);
                    return `<div class="px-3 py-2 rounded text-sm font-bold flex justify-between ${hasVoted ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-400'}"><span>${n}</span>${hasVoted ? '<span>‚úì</span>' : '<span>...</span>'}</div>`;
                }).join('');
            });
        }

        function renderIdentityPicker(code) {
            const container = document.getElementById('voter-buttons');
            container.innerHTML = participantNames.map(p => `
                <button onclick="pickIdentity('${p}')" class="w-full text-left p-4 rounded-lg border-2 border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 transition font-bold text-slate-700">
                    ${p}
                </button>
            `).join('');
        }

        function renderBooth() {
            const poolContainer = document.getElementById('pool-list');
            const rankedContainer = document.getElementById('ranked-list');
            const emptyState = document.getElementById('empty-state');
            
            poolContainer.innerHTML = '';
            rankedContainer.innerHTML = ''; 

            const currentList = tempVotes[activeTab];
            const pool = participantNames.filter(p => p !== myIdentity && !currentList.includes(p));

            pool.forEach(name => {
                const btn = document.createElement('div');
                btn.className = "bg-white p-3 rounded shadow-sm border border-slate-200 cursor-pointer hover:bg-slate-50 font-medium text-slate-700 active:scale-95 transition select-none";
                btn.innerText = name;
                btn.onclick = () => toggleRank(name);
                poolContainer.appendChild(btn);
            });

            if (currentList.length === 0) {
                rankedContainer.appendChild(emptyState);
                emptyState.style.display = 'flex';
            } else {
                emptyState.style.display = 'none';
                currentList.forEach((name, idx) => {
                    const btn = document.createElement('div');
                    btn.className = "bg-white p-3 mb-2 rounded shadow-sm border-l-4 border-indigo-500 cursor-pointer hover:bg-red-50 group flex justify-between items-center transition fade-in select-none";
                    btn.innerHTML = `<span class="font-bold text-indigo-900"><span class="text-indigo-300 mr-2">#${idx+1}</span>${name}</span> <span class="text-red-300 group-hover:text-red-500 text-xs font-bold uppercase">Remove</span>`;
                    btn.onclick = () => toggleRank(name);
                    rankedContainer.appendChild(btn);
                });
            }
        }

    </script>
</body>
</html>
